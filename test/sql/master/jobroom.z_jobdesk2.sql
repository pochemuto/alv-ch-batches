DROP VIEW JOBROOM.Z_JOBDESK2;

/* Formatted on 17.07.2018 10:41:04 (QP5 v5.215.12089.38647) */
CREATE OR REPLACE FORCE VIEW JOBROOM.Z_JOBDESK2
(
   ID,
   FINGERPRINT,
   STELLENNUMMER_AVAM,
   STELLENNUMMER_EGOV,
   URL,
   BEZEICHNUNG,
   BESCHREIBUNG,
   DETAILANGABEN,
   ERGAENZENDE_ANGABEN,
   STELLENANTRITT,
   AB_SOFORT_B,
   VERTRAGSDAUER,
   UNBEFRISTET_B,
   PENSUM_VON,
   PENSUM_BIS,
   GLEICHE_OSTE,
   ARBEITSZEIT_STD,
   LOHN_MIN,
   LOHN_MAX,
   WAEHRUNG,
   LOHNART_CODE,
   ALTER_VON,
   ALTER_BIS,
   GESCHLECHT_CODE,
   ANGABEN_ALTER,
   ARBEITSORTGEMEINDE,
   ARBEITSORT_TEXT,
   KANTON,
   ARBEITSORT_PLZ,
   ARBEITSORT_AUSLAND,
   ARBEITSORT_REGION,
   ARBEITSLAND_DE,
   ARBEITSLAND_FR,
   ARBEITSLAND_IT,
   ARBEITSAMTBEREICH,
   KATEGORIE_CODE,
   ANMELDE_DATUM,
   ABMELDE_DATUM,
   ABMELDE_GRUND_CODE,
   GUELTIGKEIT,
   PRIV_FAHRZEUG_B,
   JOB_SHARING_B,
   BEHINDERT,
   WWW_PUBLIKATION_B,
   WWW_ANONYM_B,
   SSI_PUBLIKATION_B,
   SSI_ANONYM_B,
   TELETEXT_B,
   TELETEXT_ANONYM_B,
   TELETEXT_KANAL_CODE,
   TELETEXT_ZUSATZTEXT,
   EURES_B,
   EURES_ANONYM_B,
   BEWER_SCHRIFTLICH_B,
   BEWER_ELEKTRONISCH_B,
   BEWER_TELEFONISCH_B,
   BEWER_PERSOENLICH_B,
   UNT_NAME,
   UNT_STRASSE,
   UNT_HAUS_NR,
   UNT_PLZ,
   UNT_ORT,
   UNT_POSTFACH,
   UNT_POSTFACH_PLZ,
   UNT_POSTFACH_ORT,
   UNT_LAND,
   UNT_TELEFON,
   UNT_EMAIL,
   UNT_URL,
   KP_ANREDE_CODE,
   KP_NAME,
   KP_VORNAME,
   KP_TELEFON_NR,
   KP_EMAIL,
   BQ1_AVAM_BERUF_NR,
   BQ1_QUALIFIKATION_CODE,
   BQ1_VERWANDTE_BERUFE_B,
   BQ1_ERFAHRUNG_CODE,
   BQ1_AUSBILDUNG_CODE,
   BQ2_AVAM_BERUF_NR,
   BQ2_QUALIFIKATION_CODE,
   BQ2_VERWANDTE_BERUFE_B,
   BQ2_ERFAHRUNG_CODE,
   BQ2_AUSBILDUNG_CODE,
   BQ3_AVAM_BERUF_NR,
   BQ3_QUALIFIKATION_CODE,
   BQ3_VERWANDTE_BERUFE_B,
   BQ3_ERFAHRUNG_CODE,
   BQ3_AUSBILDUNG_CODE,
   SK1_SPRACHE_CODE,
   SK1_MUENDLICH_CODE,
   SK1_SCHRIFTLICH_CODE,
   SK1_MUTTERSPRACHE_B,
   SK1_AUFENTHALT_B,
   SK2_SPRACHE_CODE,
   SK2_MUENDLICH_CODE,
   SK2_SCHRIFTLICH_CODE,
   SK2_MUTTERSPRACHE_B,
   SK2_AUFENTHALT_B,
   SK3_SPRACHE_CODE,
   SK3_MUENDLICH_CODE,
   SK3_SCHRIFTLICH_CODE,
   SK3_MUTTERSPRACHE_B,
   SK3_AUFENTHALT_B,
   SK4_SPRACHE_CODE,
   SK4_MUENDLICH_CODE,
   SK4_SCHRIFTLICH_CODE,
   SK4_MUTTERSPRACHE_B,
   SK4_AUFENTHALT_B,
   SK5_SPRACHE_CODE,
   SK5_MUENDLICH_CODE,
   SK5_SCHRIFTLICH_CODE,
   SK5_MUTTERSPRACHE_B,
   SK5_AUFENTHALT_B,
   ISCO_08_CODE,
   SOURCE,
   FULLTIME,
   EXTERN
)
AS
   SELECT a.ID,
          a.FINGERPRINT,
          a.STELLENNUMMER_AVAM,
          a.STELLENNUMMER_EGOV,
          a.URL,
          a.BEZEICHNUNG,
          a.BESCHREIBUNG,
          a.DETAILANGABEN,
          a.ERGAENZENDE_ANGABEN,
          a.STELLENANTRITT,
          a.AB_SOFORT_B,
          a.VERTRAGSDAUER,
          a.UNBEFRISTET_B,
          a.PENSUM_VON,
          a.PENSUM_BIS,
          a.GLEICHE_OSTE,
          a.ARBEITSZEIT_STD,
          a.LOHN_MIN,
          a.LOHN_MAX,
          a.WAEHRUNG,
          a.LOHNART_CODE,
          a.ALTER_VON,
          a.ALTER_BIS,
          a.GESCHLECHT_CODE,
          a.ANGABEN_ALTER,
          a.ARBEITSORTGEMEINDE,
          a.ARBEITSORT_TEXT,
          a.KANTON,
          a.ARBEITSORT_PLZ,
          a.ARBEITSORT_AUSLAND,
          a.ARBEITSORT_REGION,
          a.ARBEITSLAND_DE,
          a.ARBEITSLAND_FR,
          a.ARBEITSLAND_IT,
          a.ARBEITSAMTBEREICH,
          a.KATEGORIE_CODE,
          a.ANMELDE_DATUM,
          a.ABMELDE_DATUM,
          a.ABMELDE_GRUND_CODE,
          a.GUELTIGKEIT,
          a.PRIV_FAHRZEUG_B,
          a.JOB_SHARING_B,
          a.BEHINDERT,
          a.WWW_PUBLIKATION_B,
          a.WWW_ANONYM_B,
          a.SSI_PUBLIKATION_B,
          a.SSI_ANONYM_B,
          a.TELETEXT_B,
          a.TELETEXT_ANONYM_B,
          a.TELETEXT_KANAL_CODE,
          a.TELETEXT_ZUSATZTEXT,
          a.EURES_B,
          a.EURES_ANONYM_B,
          a.BEWER_SCHRIFTLICH_B,
          a.BEWER_ELEKTRONISCH_B,
          a.BEWER_TELEFONISCH_B,
          a.BEWER_PERSOENLICH_B,
          a.UNT_NAME,
          a.UNT_STRASSE,
          a.UNT_HAUS_NR,
          a.UNT_PLZ,
          a.UNT_ORT,
          a.UNT_POSTFACH,
          a.UNT_POSTFACH_PLZ,
          a.UNT_POSTFACH_ORT,
          a.UNT_LAND,
          a.UNT_TELEFON,
          a.UNT_EMAIL,
          a.UNT_URL,
          a.KP_ANREDE_CODE,
          a.KP_NAME,
          a.KP_VORNAME,
          a.KP_TELEFON_NR,
          a.KP_EMAIL,
          a.BQ1_AVAM_BERUF_NR,
          a.BQ1_QUALIFIKATION_CODE,
          a.BQ1_VERWANDTE_BERUFE_B,
          a.BQ1_ERFAHRUNG_CODE,
          a.BQ1_AUSBILDUNG_CODE,
          a.BQ2_AVAM_BERUF_NR,
          a.BQ2_QUALIFIKATION_CODE,
          a.BQ2_VERWANDTE_BERUFE_B,
          a.BQ2_ERFAHRUNG_CODE,
          a.BQ2_AUSBILDUNG_CODE,
          a.BQ3_AVAM_BERUF_NR,
          a.BQ3_QUALIFIKATION_CODE,
          a.BQ3_VERWANDTE_BERUFE_B,
          a.BQ3_ERFAHRUNG_CODE,
          a.BQ3_AUSBILDUNG_CODE,
		  
          a.SK1_SPRACHE_CODE,
          a.SK1_MUENDLICH_CODE,		  
          a.SK1_SCHRIFTLICH_CODE,
          
		  a.SK1_MUTTERSPRACHE_B,
          a.SK1_AUFENTHALT_B,
		  
          a.SK2_SPRACHE_CODE,
          a.SK2_MUENDLICH_CODE,
          a.SK2_SCHRIFTLICH_CODE,
          a.SK2_MUTTERSPRACHE_B,
          a.SK2_AUFENTHALT_B,
          a.SK3_SPRACHE_CODE,
          a.SK3_MUENDLICH_CODE,
          a.SK3_SCHRIFTLICH_CODE,
          a.SK3_MUTTERSPRACHE_B,
          a.SK3_AUFENTHALT_B,
          a.SK4_SPRACHE_CODE,
          a.SK4_MUENDLICH_CODE,
          a.SK4_SCHRIFTLICH_CODE,
          a.SK4_MUTTERSPRACHE_B,
          a.SK4_AUFENTHALT_B,
          a.SK5_SPRACHE_CODE,
          a.SK5_MUENDLICH_CODE,
          a.SK5_SCHRIFTLICH_CODE,
          a.SK5_MUTTERSPRACHE_B,
          a.SK5_AUFENTHALT_B,
          ISCO.ISCO_08_CODE,
          CASE WHEN a.STELLENNUMMER_AVAM IS NULL THEN 'X28' ELSE 'RAV' END
             AS SOURCE,
          CASE
             WHEN a.PENSUM_VON = 100 AND a.PENSUM_BIS = 100 THEN 1
             ELSE 0
          END
             AS FULLTIME,
          CASE WHEN a.STELLENNUMMER_AVAM IS NULL THEN 1 ELSE 0 END AS EXTERN
     FROM    OSTE_X28 a
          JOIN
             Z_JOBDESK_BERUFNR_ISCO ISCO
          ON (a.BQ1_AVAM_BERUF_NR = ISCO.AVAM_BERUF_NR)
    WHERE     ARBEITSORT_TEXT != 'Ausland' -- jobs in foreign countries crawled by X28
          AND ARBEITSORTGEMEINDE != '9999' -- jobs in foreign countries managed in AVAM
          AND (   ARBEITSORT_PLZ IS NULL
               OR REGEXP_LIKE (ARBEITSORT_PLZ, '[1-9][0-9]{3}'))
          AND a.ANMELDE_DATUM > TO_CHAR (SYSDATE - 61, 'YYYY-MM-DD');
