sudo: required
dist: trusty
services:
  - docker

language: java
jdk:
  - oraclejdk8
#  - openjdk8

env:
  global:
    - MAVEN_ARGS="--settings test/travis/maven-config.xml"
    - MAVEN_DEPLOY_ARGS="$MAVEN_ARGS -DskipTests=true"

before_install:
  - pip install --user codecov

install:

  # login to pull private docker images
  # - docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD" $DOCKER_PRIVATE_REPO

  # stop default PostgreSQL service (port conflict)
  - sudo service postgresql stop

  # create and initialize docker-based services
  - ./test/travis/create-docker-containers.sh
  - ./test/sql/master/create-master-db-schema.sh
  - ./test/elasticsearch/create-jobdesk-index.sh

script:
#  - mvn clean cobertura:cobertura coveralls:report $MAVEN_ARGS
  - mvn clean install $MAVEN_ARGS

  # Rebuild without Cobertura Instrumentation and Upload the built Artifacts
  - if [ "$TRAVIS_BRANCH" == "master" ] && [ "$TRAVIS_PULL_REQUEST" == "false" ] ; then mvn clean deploy $MAVEN_DEPLOY_ARGS ; fi

notifications:
  webhooks:
    # trigger Buildtime Trend Service to parse Travis CI log
    - https://buildtimetrend.herokuapp.com/travis
    
#   # Trick to avoid useless S3 cache updates
#   # (force this step to always return 0, as it might fail for some unkown reasons, so far...)
#   - mv $HOME/.m2/repository/ch/alv /tmp/cache-trick || /bin/true

# cache:
#   directories:
#     - '$HOME/.m2/repository'

after_success:
  - codecov
